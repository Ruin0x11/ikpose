(()=>{"use strict";var e,t={457:(e,t,i)=>{var n=i(212),s=i(886),o=i(47),r=i(931),a=i(993);class l{constructor(){this._onBoneSelectionChanged=new a.FK,this._onBoneTranslateChanged=new a.FK,this._onBoneRotateChanged=new a.FK,this._onBoneRotateFinished=new a.FK,this._onTransformSelectionChanged=new a.FK,this._onTransformStarted=new a.FK,this._onTransformFinished=new a.FK,this._onTransformChanged=new a.FK,this._onTransformRotateChanged=new a.FK,this._onPoseChanged=new a.nz,this._onSolveIkCalled=new a.nz,this._onIkSettingChanged=new a.nz,this._onIkSelectionChanged=new a.FK,this._onJointSelectionChanged=new a.FK,this._onLoadingModelFinished=new a.FK}get onBoneSelectionChanged(){return this._onBoneSelectionChanged.asEvent()}get onBoneTranslateChanged(){return this._onBoneTranslateChanged.asEvent()}get onBoneRotateChanged(){return this._onBoneRotateChanged.asEvent()}get onBoneRotateFinished(){return this._onBoneRotateFinished.asEvent()}get onTransformSelectionChanged(){return this._onTransformSelectionChanged.asEvent()}get onTransformStarted(){return this._onTransformStarted.asEvent()}get onTransformFinished(){return this._onTransformFinished.asEvent()}get onTransformChanged(){return this._onTransformChanged.asEvent()}get onTransformRotateChanged(){return this._onTransformRotateChanged.asEvent()}get onPoseChanged(){return this._onPoseChanged.asEvent()}get onSolveIkCalled(){return this._onSolveIkCalled.asEvent()}get onIkSettingChanged(){return this._onIkSettingChanged.asEvent()}get onIkSelectionChanged(){return this._onIkSelectionChanged.asEvent()}get onJointSelectionChanged(){return this._onJointSelectionChanged.asEvent()}get onLoadingModelFinished(){return this._onLoadingModelFinished.asEvent()}}const h=n.M8C.degToRad(180),d=n.M8C.degToRad(160);function g(e){return e==h||e==-h}function c(e){if(e.x==h&&e.z==h){e.clone();var t=n.M8C.radToDeg(e.y);t=t>0?180-t:-180-t,e.set(0,n.M8C.degToRad(t),0)}else if(e.z>d){e.clone();var i=e.x>0?-h+e.x:h+e.x,s=e.y>0?h-e.y:-h-e.y,o=e.z-h;e.set(i,s,o)}else e.z<-d&&(e.clone(),i=e.x>0?e.x-h:e.x+h,s=e.y>0?h-e.y:-h-e.y,o=e.z+h,e.set(i,s,o))}function u(e){var t=[];e&&e instanceof n.N$j&&t.push(e);for(var i=0;i<e.children.length;i++){const n=e.children[i];t.push.apply(t,u(n))}return t}function m(e,t){for(var i=0;i<e.length;i++)if(e[i].name.toLowerCase().endsWith(t.toLowerCase()))return i;return-1}Map;class k{constructor(e,t=34816,i=.05,s=!1){this.root=e,this.parentIndexs={},this.containerList=[],this.updateAll=!0,this.defaultBoneMatrixs=[],this.visible=!0;var o={color:t,depthTest:!1,transparent:!0,opacity:.25};this.root=e,e.updateMatrixWorld(!0),this.boneList=u(e),this.object3d=new n.ZAu,this.defaultBoneMatrixs=[];var r=this;this.boneList.forEach((function(e){for(var t=e.name,s=[];e&&e instanceof n.N$j;)s.push(e),e=e.parent;r.parentIndexs[t]=s;var a=new n.Kj0(new n.DvJ(i,i,i),new n.xoR(o));a.name="bac-"+t,a.renderOrder=1,a.visible=!1,a.userData.transformSelectionType="Joint",a.userData.bone=s[0],a.userData.isTargetable=!1,a.userData.canTranslate=!1,a.userData.ikPosition=new n.Pa4,r.containerList.push(a),s[0].add(a),a.updateMatrixWorld(!0)})),this.setVisible(this.visible),this._boneMatrix=new n.yGw,this._matrixWorldInv=new n.yGw,this._quaternion=new n._fP,this.update(),this.boneList.forEach((function(e){r.defaultBoneMatrixs.push(e.matrixWorld.clone())}))}setParentObject(e){e.add(this.object3d)}dispose(){var e=this.object3d;null!=e.parent&&e.parent.remove(e)}setCanTranslate(e,t){let i=this.getBoneIndexByBoneName(e);this.containerList[i].userData.canTranslate=t}targetBones(e,t){for(let i of this.containerList)e.has(i.userData.bone.name)&&(t?i.userData.isTargetable=!0:(i.userData.isTargetable=!1,i.visible=!1))}getBoneList(){return this.boneList}clonePositionAt(e){return this.containerList[e].position.clone()}getContainerList(){return this.containerList}getDefaultBonePosition(e){var t=this.defaultBoneMatrixs[e],i=new n.Pa4;return this._matrixWorldInv.copy(this.object3d.matrixWorld).invert(),this._boneMatrix.multiplyMatrices(this._matrixWorldInv,t),i.setFromMatrixPosition(this._boneMatrix),i}getBoneIndexByBoneName(e){for(var t=-1,i=0;i<this.boneList.length;i++)if(this.boneList[i].name==e){t=i;break}return t}getContainerByBoneIndex(e){return e<0?(console.log("BoneAttachControler.getContainerByBoneIndex:index must be 0 or greater,"+e),null):this.containerList[e]}getContainerByBoneName(e){var t=this.getBoneIndexByBoneName(e);return-1==t?(console.log("BoneAttachControler.getContainerByBoneName:not containe,"+e),null):this.containerList[t]}getContainerByBoneEndName(e){var t=m(this.boneList,e);return-1==t?(console.log("BoneAttachControler.getContainerByBoneName:not containe,"+e),null):this.containerList[t]}updateOne(e){let t=this.containerList[e],i=this.boneList[e];(this.updateAll||0!=t.children.length)&&(i.updateMatrixWorld(!0),this._boneMatrix.multiplyMatrices(this._matrixWorldInv,i.matrixWorld),t.userData.ikPosition.setFromMatrixPosition(this._boneMatrix))}updateMatrix(){this._matrixWorldInv.copy(this.object3d.matrixWorld).invert(),this.object3d.getWorldQuaternion(this._quaternion)}update(e=!1){e&&this.root.updateMatrixWorld(!0),this.updateMatrix();for(var t=0;t<this.boneList.length;t++)this.updateOne(t)}setVisible(e){this.containerList.forEach((function(t){t.material.visible=e}))}setVisibleAll(e){this.containerList.forEach((function(t){t.traverse((function(t){t instanceof n.Kj0&&t.material instanceof n.F5T&&(t.material.visible=e)}))}))}computeBoundingBox(){if(this.containerList.length<2)console.log("computeBoundingBox need at least 2 bone");else{var e=1;"bac-Global"==this.containerList[1].name&&(e=2),this.containerList.length>2&&"bac-Position"==this.containerList[2].name&&(e=3);for(var t=this.containerList[3].position,i=t.x,s=t.y,o=t.z,r=t.x,a=t.y,l=t.z,h=e+1;h<this.containerList.length;h++)(t=this.containerList[h].position).x<i&&(i=t.x),t.y<s&&(s=t.y),t.z<o&&(o=t.z),t.x>r&&(r=t.x),t.y>a&&(a=t.y),t.z>l&&(l=t.z);var d=new n.Pa4(i,s,o),g=new n.Pa4(r,a,l);this.boundingBox=new n.ZzF(d,g)}}setAllScale(e){this.containerList.forEach((function(t){t.scale.setScalar(e)}))}}let p=new n._fP,b=new n.Pa4,f=new n.Pa4,v=new n.Pa4,C=new n.USm,T=n.M8C.degToRad(.001);function w(e,t,i,s,o){var r=function(e,t,i,n){var s=b.copy(t).sub(i);s.applyQuaternion(e),s.normalize();var o=f.copy(n).sub(i);o.applyQuaternion(e),o.normalize();var r=s.dot(o),a=Math.acos(r);if(a<=T)return null;var l=v.crossVectors(s,o);return l.normalize(),p.setFromAxisAngle(l,a)}(e,t,i,s);if(null==r||isNaN(r.x))return null;if(void 0!==o&&o>0){var a=n.M8C.degToRad(o),l=C.setFromQuaternion(r),h=Math.abs(l.x);if(Math.abs(l.y)>h&&(h=Math.abs(l.y)),Math.abs(l.z)>h&&(h=Math.abs(l.z)),h>a){var d=h/a;l.x=l.x/d,l.y=l.y/d,l.z=l.z/d}return l.x>a+1e-7||l.y>a+1e-7||l.z>a+1e-7?null:(r.setFromEuler(l),r)}return r}class I{constructor(e,t){this.signals=e,this.boneAttachController=t,this.logging=!1,this.iks=new Map,this.object3d=new n.Tme,this.ikLimitMin=new Map,this.ikLimitMax=new Map,this.ikDefaultLimitMin=new Map,this.ikDefaultLimitMax=new Map,this.ikBoneRatio={},this._ikSolved={},this.selectedIk=null,this.ikPresets=null,this.ikLockX=!1,this.ikLockY=!1,this.ikLockZ=!1,this.boneLocked={},this.ikBoneSelectedOnly=!1,this.ikLimitkRotationEnabled=!0,this.followOtherIkTargets=!0,this.maxAngle=1,this.iteration=25,this.boneSelectedIndex=0,this.debug=!1,this._initialized=!1,this._enabled=!0,this._solving=!1,this._mouseDown=!1,this.lastTargetMovedPosition=new n.Pa4,this._euler=new n.USm,this._pos=new n.Pa4,this._cubeMatrix=new n.yGw,this._matrixWorldInv=new n.yGw,this._quaternion=new n._fP}onIkSelectionChanged(e){this.logging&&console.log("onIkSelectionChanged called",e)}setVisible(e){var t=this;t.getIkTargetsValue().forEach((function(i){i.visible=e;var n=t.getIkNameFromTarget(i);t.isEnableEndSiteByName(n)&&t.setEndSiteVisible(n,e)}))}setEnabled(e){this._enabled=e,this.setVisible(e)}isEnabled(){return this._enabled}addTarget(e){this.object3d.add(e)}setBoneAttachController(e){this.boneSelectedIndex=0,this.boneAttachController=e,this.resetIkSettings(),this.resetAllIkTargets(null)}resetIkSettings(){var e=this,t=this.boneAttachController.getContainerList();this.ikSettings.endSites.forEach((function(i){var n=i.userData.endSiteIndex,s=i.userData.endSiteParentIndex;t[n].add(i),t[n].add(i.userData.joint),t[n].userData.endsite=i,e.logging&&console.log("endsite position recalucurate",n);var o=t[n].position.clone().sub(t[s].position);i.userData.length&&i.userData.length,i.position.copy(o);let r=i.userData.joint;r.geometry.attributes.position.setX(0,o.x),r.geometry.attributes.position.setY(0,o.y),r.geometry.attributes.position.setZ(0,o.z),r.geometry.attributes.position.needsUpdate=!0}))}initialize(e){this.ikSettings=e,this._onbsc=e=>this.boneSelectedIndex=e,this.signals.onBoneSelectionChanged.subscribe(this._onbsc),this._onpc=()=>this.resetAllIkTargets(),this.signals.onPoseChanged.subscribe(this._onpc),this._onsic=()=>this.solveIk(!0),this.signals.onSolveIkCalled.subscribe(this._onsic),this._onisc=e=>this.onIkSelectionChanged(e),this.signals.onIkSelectionChanged.subscribe(this._onisc),this._onbrc=e=>{var t=this.getSelectedIkName();this.resetAllIkTargets(t),0==e&&this.signals._onBoneTranslateChanged.dispatch(e)},this.signals.onBoneRotateChanged.subscribe(this._onbrc),this.setBoneAttachController(this.boneAttachController),this._initialized=!0}dispose(){this.signals.onIkSelectionChanged.unsubscribe(this._onisc),this.signals.onBoneSelectionChanged.unsubscribe(this._onbsc),this.signals.onPoseChanged.unsubscribe(this._onpc),this.signals.onSolveIkCalled.unsubscribe(this._onsic),this.signals.onBoneRotateChanged.unsubscribe(this._onbrc),Object.values(this.iks).forEach((function(e){e.dispose()})),this.iks.clear()}isInitialized(){return this._initialized}getIkNameFromTarget(e){return null==e||null==e?e:e.userData.ikName?e.userData.ikName:null}getIkTargetFromName(e){return this.iks[e].target}getIkTargetsValue(){return Object.values(this.iks).map((e=>e.target))}setPresets(e){this.ikPresets&&this.ikPresets.dispose(),this.ikPresets=e,e.ikController=this}getPresets(){return this.ikPresets}getBoneList(){return this.boneAttachController.getBoneList()}getIndices(e){return this.iks[e]}getBoneRatioAsJson(){return JSON.stringify(this.ikBoneRatio)}setBoneRatioFromJson(e){this.ikBoneRatio=e,Object.keys(e).forEach((t=>{var i=this.iks[t];i&&(i.boneRatio=e[t])}))}clearBoneRatio(){Object.values(this.iks).forEach((e=>e.boneRatio=1))}setBoneRatio(e,t){this.ikBoneRatio[e]=t}getBoneRatio(e){return null==this.ikBoneRatio[e]?1:this.ikBoneRatio[e]}getSelectedIkName(){return null!=this.selectedIk?this.selectedIk.name:null}getIkNames(){return Object.keys(this.iks)}isEnableEndSiteByName(e){this.iks[e].target;var t=this.iks[e],i=t.indices[t.indices.length-1],n=this.boneAttachController.getContainerList()[i];return this.enableEndSite(n)}enableEndSite(e){return e.userData.endsite&&1==e.userData.endsite.userData.enabled}updateIkTargets(){this._matrixWorldInv.copy(this.object3d.matrixWorld).invert(),this.object3d.getWorldQuaternion(this._quaternion),this.boneAttachController.updateMatrix();for(let s in this.iks){var e=this.iks[s],t=e.indices[e.indices.length-1],i=this.boneAttachController.getContainerList()[t];let o=e.target;var n=i.userData.ikPosition;o.position.copy(n),this.boneAttachController.updateOne(t)}}resetAllIkTargets(e=null){var t=this;this.boneAttachController.update(),Object.keys(this.iks).forEach((function(i){i!=e&&t.resetIkTargetPosition(i)}))}resetIkTargetPosition(e){var t=this.iks[e].target,i=this.getLastPosition(e);t.position.copy(i)}getLastPosition(e){this.iks[e].target;var t=this.iks[e],i=t.indices[t.indices.length-1],n=this.boneAttachController.getContainerList()[i],s=n.userData.ikPosition;return this.enableEndSite(n)&&(s=n.userData.endsite.getWorldPosition(this._pos)),s}setEndSiteEnabled(e,t){null==this.iks[e].target&&console.error("setEndSiteEnabled:No target found ",e);var i=this.iks[e],n=i.indices[i.indices.length-1],s=this.boneAttachController.getContainerList()[n];s.userData.endsite.userData.enabled=t,s.userData.endsite.material.visible=t,s.userData.endsite.userData.joint.material.visible=t,this.resetIkTargetPosition(e)}setEndSiteVisible(e,t){this.iks[e].target||console.error("setEndSiteEnabled:No target found ",e);var i=this.iks[e],n=i.indices[i.indices.length-1],s=this.boneAttachController.getContainerList()[n];s.userData.endsite.material.visible=t,s.userData.endsite.userData.joint.material.visible=t}setIkTarget(e){null==e?(this.selectedIk=null,this.signals._onIkSelectionChanged.dispatch(null),this.resetAllIkTargets(null)):(this.selectedIk=this.iks[e.userData.ikName],this.signals._onIkSelectionChanged.dispatch([e,this.getIkNameFromTarget(e)]))}clearIkTarget(){this.setIkTarget(null)}solveOtherIkTargets(){var e=this.selectedIk,t=this;Object.values(this.iks).forEach((function(i){t.setIkTarget(i.target),e!=i.target&&t.solveIk(!1)&&(t._ikSolved[i.name]=!0,t.logging&&console.log("ik solved",i.name))})),this.setIkTarget(e.target)}onTransformSelectionChanged(e){var t=this;if(null==e)this.clearIkTarget();else if(e[1]&&"BoneIk"==e[1].userData.transformSelectionType&&this._enabled){t.logging&&console.log("IkController onTransformSelectionChanged");let i=e[0],n=e[1];t.setIkTarget(n),i.setMode("translate"),i.showX=!0,i.showY=!0,i.showZ=!0,t.logging&&console.log("IkController dispatch ikSelectionChanged",t.getIkNameFromTarget(n))}else this.clearIkTarget()}onTransformChanged(e){if(null!=e){let i=e[1];if("BoneIk"==i.userData.transformSelectionType){if(this.logging&&console.log("IkController onTransformChanged"),0==this._mouseDown)return void(this.logging&&console.log("IkController not mouse down"));if(this._solving)return void(this.logging&&console.log("IkController still solving ignored"));this._solving=!0;var t=this.solveIk(!1);this._solving=!1,t&&(this._ikSolved[this.getIkNameFromTarget(i)]=!0,this.logging&&console.log("ik solved",this.getIkNameFromTarget(i)),this.followOtherIkTargets||this.solveOtherIkTargets()),this.boneAttachController.update()}else this.resetAllIkTargets()}}onTransformRotateChanged(e){null!=e&&this.resetAllIkTargets()}onTransformStarted(e){null!=e&&"BoneIk"==e.userData.transformSelectionType&&(this.logging&&console.log("IkController onTransformStarted"),this._mouseDown=!0,this._ikSolved={},this.resetAllIkTargets(this.getIkNameFromTarget(e)))}onTransformFinished(e){var t=this;null!=e&&"BoneIk"==e.userData.transformSelectionType&&(this.logging&&console.log("IkController onTransformFinished"),this._mouseDown=!1,Object.keys(this._ikSolved).forEach((function(e){1==t._ikSolved[e]&&t.getEffectedBoneIndices(e).forEach((function(e){t.signals._onBoneRotateChanged.dispatch(e),t.logging&&console.log("IkController dispatch boneRotationChanged",e),t.signals._onBoneRotateFinished.dispatch(e),t.logging&&console.log("IkController dispatch boneRotationFinished",e)}))})),this.resetAllIkTargets())}getEffectedBoneIndices(e){for(var t=this.iks[e].indices,i=[],n=this.isEnableEndSiteByName(e)?t.length:t.length-1,s=0;s<n;s++){var o=t[s];i.push(o)}return i}solveIk(e=!1){this.logging&&console.log("call solveIk ",this.selectedIk),e=null!=e&&e;var t=this;function i(e){var i=e.userData.ikPosition;return t.enableEndSite(e)&&(i=e.userData.endsite.getWorldPosition(t._pos)),i}if(null==this.selectedIk)return this.debug&&console.log("ikTarget is null"),!1;var s,o,r=this.selectedIk.name,a=this.selectedIk.indices,l=this.boneAttachController.getContainerList()[a[a.length-1]],h=this.selectedIk.target,d=h.position;if(this.lastTargetMovedPosition.equals(d)&&0==e)return this.debug&&console.log(r,"lastTargetMovedPosition same as targetPos forceUpdate=",e),!1;if(this.lastTargetMovedPosition.copy(d),h.position.equals(i(l)))return this.debug&&console.log(r,"ik target pos == endsitepos"),!1;for(var u=0;u<this.iteration;u++){for(var m=t.enableEndSite(l)?a.length:a.length-1,k=0;k<m;k++){var p=a[k];if(this.ikBoneSelectedOnly&&p!=this.boneSelectedIndex)this.logging&&console.log("ik ikBoneSelectedOnly & skipped",p);else{var b=i(l),f=this.boneAttachController.getBoneList()[p],v=f.name,C=this.boneAttachController.getContainerList()[a[k]].userData.ikPosition;if(this.boneLocked[v])this.logging&&console.log("ik bonelocked & skipped",v);else{if(d.equals(b))return this.logging&&console.log(r,"no need ik, skipped"),!1;var T=f.parent.getWorldQuaternion(new n._fP).invert();f.parent,n.N$j;var I=this.maxAngle*this.getBoneRatio(f.name);this.logging&&console.log("ik maxAngle",v,I);var S=w(T,b,C,d,I);if(null!=S){var M=f.rotation.order,B=this._euler.setFromQuaternion(S,M),L=f.rotation;c(L);var _=L.x,P=L.y,y=L.z;if(g(_)||g(P)||g(y))s=L,o=void 0!==(o="not safe ik angles")?o:"",console.log(n.M8C.radToDeg(s.x),n.M8C.radToDeg(s.y),n.M8C.radToDeg(s.z),o);else{if(this.ikLimitkRotationEnabled){function x(e,t){var i=n.M8C.radToDeg(e+t);return i>180&&(i-=360),i<-180&&(i+=180),i}const e=this.ikLimitMin[f.name],t=this.ikLimitMax[f.name];if(e){var D=x(_,B.x);!this.ikLockX&&D>=e.x&&D<=t.x?_+=B.x:this.debug&&console.log(f.name,"limit-x",e.x,t.x,D);var E=x(P,B.y);!this.ikLockY&&E>=e.y&&E<=t.y?P+=B.y:this.debug&&console.log(f.name,"limit-y",e.y,t.y,E);var A=x(y,B.z);!this.ikLockZ&&A>=e.z&&A<=t.z?y+=B.z:this.debug&&console.log(f.name,"limit-z",e.z,t.z,A),_>Math.PI&&(_-=2*Math.PI),P>Math.PI&&(P-=2*Math.PI),y>Math.PI&&(y-=2*Math.PI),_<-Math.PI&&(_+=2*Math.PI),P<-Math.PI&&(P+=2*Math.PI),y<-Math.PI&&(y+=2*Math.PI)}else this.logging&&console.log("no ikLimitMin",f.name)}else this.logging&&console.log("ik not limited",v,B.x.toFixed(2),B.y.toFixed(2),B.z.toFixed(2)),_+=B.x,P+=B.y,y+=B.z;f.rotation.set(_,P,y)}}else this.logging&&console.log("null quaternion")}}}for(this.boneAttachController.updateMatrix(),k=m;k>=0;k--)this.boneAttachController.updateOne(a[k])}return this.followOtherIkTargets&&this.resetAllIkTargets(r),!0}}class S{constructor(e,t){this.indices=e,this.name=t,this.boneRatio=1}addToScene(e){if(!this.target)throw new Error("Target not ready!");e.add(this.target)}dispose(){this.target&&this.target.parent.remove(this.target)}}var M=r.wZ.HumanoidBoneName;class B{constructor(e,t,i){this.ikController=e,this.boneAttachController=t,this.endSites=[],this.ikTargets={},this.bodyHumanBoneNames=[M.Hips,M.Spine,M.Chest,M.UpperChest,M.Neck,M.Head];var n=i.humanoid.humanBones,s=new Map;for(let e in n){let t=n[e];t[0]&&(s[e]=t[0].node.name)}function o(e){var t=[];return e.forEach((function(e){var i=n[e];if(i){var s=i[0];null!=s?t.push(s.node.name):console.log("humanBoneMap:found on map not in bonelist",e)}else console.log("humanBoneMap:not map found",e)})),t}if(this.humanBoneMap=s,this.boneIkMap=new Map,this.boneList=u(i.scene),this.headBoneNames=o([M.Spine,M.Chest,M.UpperChest,M.Neck,M.Head]),this.registIk(this.ikTargets,"Head",this.headBoneNames),this.leftArmBoneNames=o([M.LeftShoulder,M.LeftUpperArm,M.LeftLowerArm,M.LeftHand]),this.registIk(this.ikTargets,"LeftArm",this.leftArmBoneNames),this.rightArmBoneNames=o([M.RightShoulder,M.RightUpperArm,M.RightLowerArm,M.RightHand]),this.registIk(this.ikTargets,"RightArm",this.rightArmBoneNames),this.leftLegBoneNames=o([M.LeftUpperLeg,M.LeftLowerLeg,M.LeftFoot]),this.registIk(this.ikTargets,"LeftLeg",this.leftLegBoneNames),this.rightLegBoneNames=o([M.RightUpperLeg,M.RightLowerLeg,M.RightFoot]),this.registIk(this.ikTargets,"RightLeg",this.rightLegBoneNames),this.hipBoneNames=o([M.Hips,M.Spine]),this.hipBoneNames.length>1){this.registIk(this.ikTargets,"Hip",this.hipBoneNames);for(let e of this.hipBoneNames)this.boneAttachController.setCanTranslate(e,!0)}this.initlimitBone()}registIk(e,t,i){if(0==i.length)throw new Error("No joint names");var s=[],o=this.ikController.iks[t];o&&o.dispose(),this.ikController.iks[t]=new S(s,t);var r=this;i.forEach((function(e){var i=m(r.boneList,e);-1==i&&console.error("registIk:bone not contain,"+e),s.push(i),r.boneIkMap[e]=t}));var a=this.boneAttachController.getContainerList(),l=new n.Kj0(new n.DvJ(.02,.02,.02),new n.vBJ({color:34816,depthTest:!1,transparent:!0,opacity:.5}));l.renderOrder=2,a[s[s.length-1]].add(l),a[s[s.length-1]].userData.endsite=l,l.material.visible=!1,l.userData.endSiteIndex=s[s.length-1],l.userData.endSiteParentIndex=s[s.length-2];var h=function(e,t){const i=[];i.push(new n.Pa4),i.push(t.position.clone());const s=(new n.u9r).setFromPoints(i);var o=new n.nls({color:11184844}),r=new n.x12(s,o);return e.add(r),r}(a[s[s.length-1]],l);const d=h.material;d.depthTest=!1,d.transparent=!0,d.opacity=.25,h.renderOrder=2,d.visible=!1,l.userData.joint=h,this.endSites.push(l);var g=new n.Kj0(new n.DvJ(.05,.05,.05),new n.vBJ({color:8912896,depthTest:!1,transparent:!0,opacity:.5}));g.name="ik-c-"+t,g.renderOrder=1,s.length,g.userData.ikName=t,g.userData.transformSelectionType="BoneIk",this.ikController.addTarget(g),this.ikController.iks[t].target=g,this.boneAttachController.targetBones(new Set(i),!0)}limitBone(e,t,i,s,o,r,a,l){var h=this.humanBoneMap[t];if(!h)throw new Error("Not found: "+t);this.ikController.ikLimitMin[h]=new n.Pa4(i,s,o),this.ikController.ikLimitMax[h]=new n.Pa4(r,a,l)}initlimitBone(){var e=this.boneList;this.limitBone(e,M.Hips,-180,-180,-180,180,180,180),this.limitBone(e,M.Spine,-15,-30,-20,15,30,20),this.limitBone(e,M.Chest,-45,-30,-20,45,30,20),this.limitBone(e,M.UpperChest,-45,-30,-20,45,30,20),this.limitBone(e,M.Neck,-45,-45,-10,45,45,10),this.limitBone(e,M.Head,-15,-30,-20,15,30,20),this.limitBone(e,M.LeftShoulder,0,0,-45,0,15,0),this.limitBone(e,M.LeftUpperArm,-45,-75,-45,45,45,85),this.limitBone(e,M.LeftLowerArm,-0,-150,0,0,0,0),this.limitBone(e,M.LeftHand,0,0,-45,0,45,65),this.limitBone(e,M.RightShoulder,0,-15,0,0,0,45),this.limitBone(e,M.RightUpperArm,-45,-45,-85,45,75,45),this.limitBone(e,M.RightLowerArm,0,0,0,0,150,0),this.limitBone(e,M.RightHand,0,-45,-65,0,0,45),this.limitBone(e,M.LeftUpperLeg,-60,0,-75,120,0,75),this.limitBone(e,M.LeftLowerLeg,-160,0,0,0,0,0),this.limitBone(e,M.LeftFoot,-15,-5,-5,15,5,5),this.limitBone(e,M.RightUpperLeg,-60,0,-75,120,0,75),this.limitBone(e,M.RightLowerLeg,-160,0,0,0,0,0),this.limitBone(e,M.RightFoot,-15,-5,-5,15,5,5);var t=this;Object.keys(this.ikController.iks).forEach((function(e){t.ikController.ikDefaultLimitMin[e]=new n.Pa4(t.ikController.iks[e].limitMin),t.ikController.ikDefaultLimitMax[e]=new n.Pa4(t.ikController.iks[e].limitMax)}))}}class L{constructor(e,t,i){this.signals=e,this.boneAttachController=t,this.ikController=i,this.logging=!1,this._mouseDown=!1,this._enabled=!0}setJointTarget(e){null==e?(this.selectedJoint=null,this.signals._onJointSelectionChanged.dispatch(null)):(this.selectedJoint=e,this.signals._onJointSelectionChanged.dispatch(e))}clearJointTarget(){this.setJointTarget(null)}onTransformSelectionChanged(e){if(null==e)this.clearJointTarget();else if(e[1]&&"Joint"==e[1].userData.transformSelectionType&&e[1].userData.isTargetable&&this._enabled){this.logging&&console.log("JointController onTransformSelectionChanged");let t=e[0],i=e[1];this.setJointTarget(i);let n=i.userData.bone;const s=this.ikController.ikLimitMin[n.name],o=this.ikController.ikLimitMax[n.name];i.userData.isSelected&&"rotate"==t.getMode()&&i.userData.canTranslate?(t.setMode("translate"),t.showX=!0,t.showY=!0,t.showZ=!0):(t.setMode("rotate"),s?(t.showX=s.x<o.x,t.showY=s.y<o.y,t.showZ=s.z<o.z):(t.showX=!0,t.showY=!0,t.showZ=!0))}else this.clearJointTarget()}onTransformChanged(e){if(null!=e&&"Joint"==e[1].userData.transformSelectionType&&e[1].userData.isTargetable){let h=e[1].userData.bone;const d=this.ikController.ikLimitMin[h.name],g=this.ikController.ikLimitMax[h.name];var t=h.rotation;let c=t.x,u=t.y,m=t.z;if(d){var i=n.M8C.degToRad(d.x),s=n.M8C.degToRad(g.x),o=n.M8C.degToRad(d.y),r=n.M8C.degToRad(g.y),a=n.M8C.degToRad(d.z),l=n.M8C.degToRad(g.z);c=Math.min(Math.max(c,i),s),u=Math.min(Math.max(u,o),r),m=Math.min(Math.max(m,a),l)}h.rotation.set(c,u,m)}}onTransformRotateChanged(e){null!=e&&"Joint"==e[1].userData.transformSelectionType&&e[1].userData.isTargetable&&(e[1],this.logging&&console.log("JointController onTransformChanged"),0==this._mouseDown)&&this.logging&&console.log("JointController not mouse down")}onTransformStarted(e){null!=e&&"Joint"==e.userData.transformSelectionType&&e.userData.isTargetable&&(this.logging&&console.log("JointController onTransformStarted"),this._mouseDown=!0)}onTransformFinished(e){null!=e&&"Joint"==e.userData.transformSelectionType&&e.userData.isTargetable&&(this.logging&&console.log("JointController onTransformFinished"),this._mouseDown=!1)}}class _{constructor(e,t){this.signals=e,this.vrm=t,this.boneAttachController=new k(this.vrm.scene),this.ikController=new I(this.signals,this.boneAttachController),this.jointController=new L(this.signals,this.boneAttachController,this.ikController),this._onpc=()=>this.boneAttachController.update(!0),this.signals.onPoseChanged.subscribe(this._onpc),this.settings=new B(this.ikController,this.boneAttachController,this.vrm),this.ikController.initialize(this.settings),this.signals._onIkSettingChanged.dispatch(),this._ontsc=e=>this.onTransformSelectionChanged(e),this._onts=e=>this.onTransformStarted(e),this._ontf=e=>this.onTransformFinished(e),this._ontc=e=>this.onTransformChanged(e),this._ontrc=e=>this.onTransformRotateChanged(e),this.signals.onTransformSelectionChanged.subscribe(this._ontsc),this.signals.onTransformStarted.subscribe(this._onts),this.signals.onTransformFinished.subscribe(this._ontf),this.signals.onTransformChanged.subscribe(this._ontc),this.signals.onTransformRotateChanged.subscribe(this._ontrc),this._onbtc=()=>this.ikController.resetAllIkTargets(),this.signals.onBoneTranslateChanged.subscribe(this._onbtc),this.signals._onLoadingModelFinished.dispatch(this)}addToScene(e){e.add(this.ikController.object3d),e.add(this.vrm.scene),this.ikController.clearIkTarget(),this.ikController.object3d.updateWorldMatrix(!0,!0)}loadPose(e){this.vrm.humanoid.setPose(e),this.ikController.clearIkTarget()}serializePose(){return this.vrm.humanoid.getPose()}resetPose(){for(let e in r.wZ.HumanoidBoneName){let t=r.wZ.HumanoidBoneName[e],i=this.vrm.humanoid.getBoneNode(t);i&&i.quaternion.set(0,0,0,0)}this.ikController.clearIkTarget()}update(e){this.vrm.update(e)}onTransformSelectionChanged(e){this.jointController.onTransformSelectionChanged(e),this.ikController.onTransformSelectionChanged(e)}onTransformStarted(e){this.jointController.onTransformStarted(e),this.ikController.onTransformStarted(e)}onTransformFinished(e){this.jointController.onTransformFinished(e),this.ikController.onTransformFinished(e)}onTransformChanged(e){this.jointController.onTransformChanged(e),this.ikController.onTransformChanged(e)}onTransformRotateChanged(e){this.jointController.onTransformRotateChanged(e),this.ikController.onTransformRotateChanged(e)}dispose(){this.signals.onPoseChanged.unsubscribe(this._onpc),this.signals.onTransformSelectionChanged.unsubscribe(this._ontsc),this.signals.onTransformStarted.unsubscribe(this._onts),this.signals.onTransformFinished.unsubscribe(this._ontf),this.signals.onTransformChanged.unsubscribe(this._ontc),this.signals.onTransformRotateChanged.unsubscribe(this._ontrc),this.signals.onBoneTranslateChanged.unsubscribe(this._onbtc),this.boneAttachController.dispose(),this.ikController.dispose()}}var P=i(633);class y{constructor(e,t){this.signals=e,this.ikpose=t,this.lastSelection=null,this.visibleJoint=null,this.onDownPosition=new n.FM8,this.onUpPosition=new n.FM8,this.onMovePosition=new n.FM8,this.onDoubleClickPosition=new n.FM8,this.dragging=!1,this._onpu=null;var i=this;this.control=new P.Ys(t.camera,t.renderer.domElement),this.control.setSpace("local"),this.control.addEventListener("dragging-changed",(function(e){i.ikpose.controls.enabled=!e.value,i.dragging=e.value})),this.control.addEventListener("change",(function(e){i.dragging&&i.signals._onTransformChanged.dispatch([i.control,i.target]),i.ikpose.render()})),this.control.addEventListener("rotationAngle-changed",(function(e){i.signals._onTransformRotateChanged.dispatch([i.control,i.target]),i.ikpose.render()})),this.control.detach(),t.scene.add(this.control),this.signals.onTransformSelectionChanged.subscribe((function(e){let t=e[1];i.target&&"Joint"==i.target.userData.transformSelectionType&&(i.target.visible=!1,i.target.userData.isSelected=!1),i.target=t,null==t?i.control.detach():i.target.userData.isSelected=!0})),this._onpu=e=>this.onPointerUp(e),window.addEventListener("pointerdown",(e=>this.onPointerDown(e)),!1),window.addEventListener("pointerup",this._onpu,!1),window.addEventListener("pointermove",(e=>this.onPointerMove(e)),!1)}selectTarget(e){this.signals._onTransformSelectionChanged.dispatch([this.control,e])}setTarget(e){let t=e;e&&"Joint"==e.userData.transformSelectionType&&(t=e.parent),this.control.attach(t)}getIntersects(e,t){var i=new n.iMs,s=new n.FM8;return s.set(2*e.x-1,-2*e.y+1),i.setFromCamera(s,this.ikpose.camera),i.intersectObjects(t)}getMousePosition(e,t,i){var n=e.getBoundingClientRect();return[(t-n.left)/n.width,(i-n.top)/n.height]}onPointerUp(e){var t=this.getMousePosition(this.ikpose.renderer.domElement,e.clientX,e.clientY);this.onUpPosition.fromArray(t),this.handleClick(),this.signals._onTransformFinished.dispatch(this.target),this.ikpose.render()}onPointerDown(e){var t=this.getMousePosition(this.ikpose.renderer.domElement,e.clientX,e.clientY);this.onDownPosition.fromArray(t),this.signals._onTransformStarted.dispatch(this.target),this.ikpose.render()}onPointerMove(e){var t=this.getMousePosition(this.ikpose.renderer.domElement,e.clientX,e.clientY);this.onMovePosition.fromArray(t);var i=this.getIntersects(this.onMovePosition,this.ikpose.getJointTargets());let n=null;if(i.length>0)for(var s=0;s<i.length;s++){let e=i[s].object;if("Joint"==e.userData.transformSelectionType&&e.userData.isTargetable){n=e;break}}let o=!1;n&&n!=this.visibleJoint?(this.visibleJoint&&(this.visibleJoint.visible=!1,this.visibleJoint=null),this.visibleJoint=n,this.visibleJoint.visible=!0,o=!0):!n&&this.visibleJoint&&(this.visibleJoint.visible=!1,this.visibleJoint=null,o=!0),this.target&&(this.target.visible=!0),o&&this.ikpose.render()}handleClick(){if(0===this.onDownPosition.distanceTo(this.onUpPosition)){var e=this.ikpose.getIkTargets();this.visibleJoint&&e.push(this.visibleJoint);var t=this.getIntersects(this.onUpPosition,e);if(t.length>0){for(var i=-1,n=[],s=0;s<t.length;s++)t[s].object.visible&&n.push(t[s]);if(0==n.length)return void this.selectTarget(null);i=0,0==n.length?this.lastSelection=null:n[0].object==this.lastSelection&&n.length>1?(i=1,this.lastSelection=n[1].object):this.lastSelection=n[0].object;var o=n[i].object;this.selectTarget(o)}else this.selectTarget(null)}}}var x=i(498),D=i.n(x),E=i(171),A=i.n(E),R=i(162),F=i.n(R);const j=new class{constructor(){this.ikModels=[],this.params={showIk:!0,updateModels:!0},this.renderer=new n.CP7({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this.renderer.domElement),this.scene=new n.xsS,this.scene.background=new n.Ilk(15790320),this.camera=new n.cPb(45,window.innerWidth/window.innerHeight,.1,1e4),this.camera.position.set(0,2,-3.5),this.scene.add(this.camera),this.signals=new l,this.clock=new n.SUY,this.addLight(),this.addPlane(),this.addGrid(),this.bindControls(),this.openGUI(),this.render(),this.params.updateModels&&this.loopUpdate()}addLight(){this.scene.add(new n.Mig(15790320));const e=new n.PMe(16777215,1.5);e.position.set(0,1500,200),e.angle=.2*Math.PI,e.castShadow=!0,e.shadow.camera.near=200,e.shadow.camera.far=2e3,e.shadow.bias=-222e-6,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,this.scene.add(e)}addPlane(){const e=new n._12(2e3,2e3);e.rotateX(-Math.PI/2);const t=new n.Tn7({opacity:.2}),i=new n.Kj0(e,t);i.position.y=-1,i.receiveShadow=!0,this.scene.add(i)}addGrid(){const e=new n.VLJ(50,100);e.position.y=0;const t=e.material;t.opacity=.25,t.transparent=!0,this.scene.add(e)}bindControls(){var e=this;this.controls=new s.z(this.camera,this.renderer.domElement),this.controls.addEventListener("change",(()=>e.render())),this.controls.target.set(0,1,0),this.controls.update(),this.transformHandler=new y(this.signals,this),this.signals.onJointSelectionChanged.subscribe((t=>{t&&e.transformHandler.setTarget(t),e.render()})),this.signals.onIkSelectionChanged.subscribe((t=>{t&&e.transformHandler.setTarget(t[0]),e.render()})),window.addEventListener("resize",(function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight),e.render()}),!1)}openGUI(){let e=this;this.gui=new(D()),this.gui.addInput(this.params,"showIk",{label:"Show IK"}).on("change",(t=>e.setShowIk(t.value))),this.gui.addInput(this.params,"updateModels",{label:"Update Models"}).on("change",(e=>this.loopUpdate())),this.folderModels=this.gui.addFolder({title:"Models"})}setShowIk(e){for(let t of this.ikModels)t.ikController.setVisible(e);this.transformHandler.selectTarget(null),this.render()}render(){this.renderer.render(this.scene,this.camera)}update(e){this.ikModels.forEach((t=>t.update(e)))}loopUpdate(){if(this.params.updateModels){window.requestAnimationFrame(this.loopUpdate.bind(this));let e=this.clock.getDelta();this.update(e),this.render()}}loadModel(e,t){(new o.E).load(e,(e=>r.n4.from(e).then((e=>this.onModelLoadSuccess(e,t)))),(e=>this.onModelLoadProgress(e)),(e=>this.onModelLoadError(e)))}loadPose(e,t){var i=this;fetch(t).then((e=>e.json())).then((t=>{e.loadPose(t),i.render()}))}queryLoadPose(e){var t=this;A()({multiple:!1,accept:"application/json"}).then((i=>{let n=new FileReader;n.addEventListener("load",(()=>{let i=JSON.parse(n.result);e.loadPose(i),t.render()})),n.readAsText(i[0])}))}savePose(e){let t=e.serializePose(),i=window.prompt("Please enter a filename.","pose");if(null==i)return;i=`${i}.json`;let n=function(e){let t=Object.create(null);for(let[i,n]of Object.entries(e))t[i]=n;return t}(t),s=JSON.stringify(n),o=new Blob([s],{type:"application/json;charset=utf-8"});F().saveAs(o,i)}onModelLoadSuccess(e,t){const i=new _(this.signals,e);this.ikModels.push(i),i.vrm.scene.position.copy(t),i.ikController.setVisible(this.params.showIk),i.addToScene(this.scene);var n=this;let s=this.folderModels.addFolder({expanded:!0,title:i.vrm.meta.title});s.addButton({title:"Load Pose"}).on("click",(()=>n.queryLoadPose(i))),s.addButton({title:"Save Pose"}).on("click",(()=>n.savePose(i))),s.addButton({title:"Reset Pose"}).on("click",(()=>i.resetPose())),console.log(e),this.render()}onModelLoadProgress(e){console.log("Loading model...",e.loaded/e.total*100,"%")}onModelLoadError(e){console.error(e)}getIkTargets(){const e=this.ikModels.map((e=>e.ikController.getIkTargetsValue()));return[].concat.apply([],e)}getJointTargets(){const e=this.ikModels.map((e=>e.boneAttachController.getContainerList()));return[].concat.apply([],e)}};j.loadModel("/assets/models/three-vrm-girl.vrm",new n.Pa4(-.5,0,0)),j.loadModel("/assets/models/AliciaSolid.vrm",new n.Pa4(.5,0,0))}},i={};function n(e){var s=i[e];if(void 0!==s)return s.exports;var o=i[e]={exports:{}};return t[e].call(o.exports,o,o.exports,n),o.exports}n.m=t,e=[],n.O=(t,i,s,o)=>{if(!i){var r=1/0;for(h=0;h<e.length;h++){for(var[i,s,o]=e[h],a=!0,l=0;l<i.length;l++)(!1&o||r>=o)&&Object.keys(n.O).every((e=>n.O[e](i[l])))?i.splice(l--,1):(a=!1,o<r&&(r=o));a&&(e.splice(h--,1),t=s())}return t}o=o||0;for(var h=e.length;h>0&&e[h-1][2]>o;h--)e[h]=e[h-1];e[h]=[i,s,o]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={179:0};n.O.j=t=>0===e[t];var t=(t,i)=>{var s,o,[r,a,l]=i,h=0;for(s in a)n.o(a,s)&&(n.m[s]=a[s]);for(l&&l(n),t&&t(i);h<r.length;h++)o=r[h],n.o(e,o)&&e[o]&&e[o][0](),e[r[h]]=0;n.O()},i=self.webpackChunkikpose=self.webpackChunkikpose||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var s=n.O(void 0,[910],(()=>n(457)));s=n.O(s)})();