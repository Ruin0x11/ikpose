(()=>{"use strict";var e,t={6745:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.lineTo=t.removeAllFromArray=t.printDeg=void 0;const i=n(2212);t.printDeg=function(e,t){t=void 0!==t?t:"",console.log(i.MathUtils.radToDeg(e.x),i.MathUtils.radToDeg(e.y),i.MathUtils.radToDeg(e.z),t)},t.removeAllFromArray=function(e,t){return t.forEach((function(t){var n=e.indexOf(t);-1==n||e.splice(n,1)})),e},t.lineTo=function(e,t){const n=[];n.push(new i.Vector3),n.push(t.position.clone());const o=(new i.BufferGeometry).setFromPoints(n);var s=new i.LineBasicMaterial({color:11184844}),r=new i.Line(o,s);return e.add(r),r}},7270:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BoneAttachController=void 0;const i=n(2212),o=n(5243);t.BoneAttachController=class{constructor(e,t=34816,n=.05,s=!1){this.root=e,this.parentIndexs={},this.containerList=[],this.updateAll=!0,this.defaultBoneMatrixs=[],this.visible=!0;var r={color:t,depthTest:!1,transparent:!0,opacity:.25};this.root=e,e.updateMatrixWorld(!0),this.boneList=o.getBoneList(e),this.object3d=new i.Group,this.defaultBoneMatrixs=[];var a=this;this.boneList.forEach((function(e){for(var t=e.name,o=[];e&&e instanceof i.Bone;)o.push(e),e=e.parent;a.parentIndexs[t]=o;var s=new i.Mesh(new i.BoxGeometry(n,n,n),new i.MeshPhongMaterial(r));s.name="bac-"+t,s.renderOrder=1,s.visible=!1,s.userData.transformSelectionType="Joint",s.userData.bone=o[0],s.userData.isTargetable=!1,s.userData.canTranslate=!1,s.userData.ikPosition=new i.Vector3,a.containerList.push(s),o[0].add(s),s.updateMatrixWorld(!0)})),this.setVisible(this.visible),this._boneMatrix=new i.Matrix4,this._matrixWorldInv=new i.Matrix4,this._quaternion=new i.Quaternion,this.update(),this.boneList.forEach((function(e){a.defaultBoneMatrixs.push(e.matrixWorld.clone())}))}setParentObject(e){e.add(this.object3d)}dispose(){var e=this.object3d;null!=e.parent&&e.parent.remove(e)}setCanTranslate(e,t){let n=this.getBoneIndexByBoneName(e);this.containerList[n].userData.canTranslate=t}targetBones(e,t){for(let n of this.containerList)e.has(n.userData.bone.name)&&(t?n.userData.isTargetable=!0:(n.userData.isTargetable=!1,n.visible=!1))}getBoneList(){return this.boneList}clonePositionAt(e){return this.containerList[e].position.clone()}getContainerList(){return this.containerList}getDefaultBonePosition(e){var t=this.defaultBoneMatrixs[e],n=new i.Vector3;return this._matrixWorldInv.copy(this.object3d.matrixWorld).invert(),this._boneMatrix.multiplyMatrices(this._matrixWorldInv,t),n.setFromMatrixPosition(this._boneMatrix),n}getBoneIndexByBoneName(e){for(var t=-1,n=0;n<this.boneList.length;n++)if(this.boneList[n].name==e){t=n;break}return t}getContainerByBoneIndex(e){return e<0?(console.log("BoneAttachControler.getContainerByBoneIndex:index must be 0 or greater,"+e),null):this.containerList[e]}getContainerByBoneName(e){var t=this.getBoneIndexByBoneName(e);return-1==t?(console.log("BoneAttachControler.getContainerByBoneName:not containe,"+e),null):this.containerList[t]}getContainerByBoneEndName(e){var t=o.findBoneIndexByEndsName(this.boneList,e);return-1==t?(console.log("BoneAttachControler.getContainerByBoneName:not containe,"+e),null):this.containerList[t]}updateOne(e){let t=this.containerList[e],n=this.boneList[e];(this.updateAll||0!=t.children.length)&&(n.updateMatrixWorld(!0),this._boneMatrix.multiplyMatrices(this._matrixWorldInv,n.matrixWorld),t.userData.ikPosition.setFromMatrixPosition(this._boneMatrix))}updateMatrix(){this._matrixWorldInv.copy(this.object3d.matrixWorld).invert(),this.object3d.getWorldQuaternion(this._quaternion)}update(e=!1){e&&this.root.updateMatrixWorld(!0),this.updateMatrix();for(var t=0;t<this.boneList.length;t++)this.updateOne(t)}setVisible(e){this.containerList.forEach((function(t){t.material.visible=e}))}setVisibleAll(e){this.containerList.forEach((function(t){t.traverse((function(t){t instanceof i.Mesh&&t.material instanceof i.Material&&(t.material.visible=e)}))}))}computeBoundingBox(){if(this.containerList.length<2)console.log("computeBoundingBox need at least 2 bone");else{var e=1;"bac-Global"==this.containerList[1].name&&(e=2),this.containerList.length>2&&"bac-Position"==this.containerList[2].name&&(e=3);for(var t=this.containerList[3].position,n=t.x,o=t.y,s=t.z,r=t.x,a=t.y,l=t.z,h=e+1;h<this.containerList.length;h++)(t=this.containerList[h].position).x<n&&(n=t.x),t.y<o&&(o=t.y),t.z<s&&(s=t.z),t.x>r&&(r=t.x),t.y>a&&(a=t.y),t.z>l&&(l=t.z);var d=new i.Vector3(n,o,s),c=new i.Vector3(r,a,l);this.boundingBox=new i.Box3(d,c)}}setAllScale(e){this.containerList.forEach((function(t){t.scale.setScalar(e)}))}}},5243:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.swapHorizontalBone=t.flipHorizontalRotation=t.getOppositeLRName=t.resetBone=t.convertToZeroRotatedBoneMesh=t.findBoneByEndsName=t.findBoneByBoneName=t.findBoneIndexByEndsName=t.findBoneIndexByBoneName=t.makeEmptyBoneMatrix=t.storeDefaultBoneMatrix=t.BoneMatrixMap=t.BoneMatrix=t.makeQuaternionFromXYZRadian=t.makeQuaternionFromXYZDegree=t.boneListToOptions=t.getBoneNameOptions=t.getBoneIdOptions=t.makeBoneList=t.getBoneList=t.copyIndicesAndWeights=t.initializeIndicesAndWeights=t.createBonesFromPoints=t.Bone=t.convertToIkSafeRoatation=t.isD180=void 0;const i=n(2212);const o=i.MathUtils.degToRad(180),s=i.MathUtils.degToRad(160);t.isD180=function(e){return e==o||e==-o},t.convertToIkSafeRoatation=function(e){if(e.x==o&&e.z==o){e.clone();var t=i.MathUtils.radToDeg(e.y);t=t>0?180-t:-180-t,e.set(0,i.MathUtils.degToRad(t),0)}else if(e.z>s){e.clone();var n=e.x>0?-o+e.x:o+e.x,r=e.y>0?o-e.y:-o-e.y,a=e.z-o;e.set(n,r,a)}else e.z<-s&&(e.clone(),n=e.x>0?e.x-o:e.x+o,r=e.y>0?o-e.y:-o-e.y,a=e.z+o,e.set(n,r,a))};class r{constructor(e,t){this.parent=e,this.name=t,this.pos=[0,0,0],this.scl=[1,1,1],this.rotq=[0,0,0,1]}}function a(e){var t=[];e&&e instanceof i.Bone&&t.push(e);for(var n=0;n<e.children.length;n++){const i=e.children[n];t.push.apply(t,a(i))}return t}function l(e,t,n,o,s){o=void 0!==o?o:new i.Euler,s=void 0!==s?s:"XYZ";var r=new i.Quaternion,a=new i.Euler(e+o.x,t+o.y,n+o.z,s);return r.setFromEuler(a),r}t.Bone=r,t.createBonesFromPoints=function(e,t){var n=[],o=new r(-1,"root");n.push(o);for(var s=t+1,a=e.length/s,l=new i.Vector3,h=0;h<s;h++)l.add(e[h]);l.divideScalar(s),o.pos=l.toArray();var d=1;for(h=0;h<s;h++)for(var c=0,g=l.clone(),u=0;u<a;u++){var m=e[s*u+h],p=new r(c,h+"-"+u);p.pos=m.clone().sub(g).toArray(),n.push(p),c=d,d++,g=m}return n},t.initializeIndicesAndWeights=function(e,t){if(e)if(e.isGeometry){t=void 0!==t?t:0,e.skinIndices=[],e.skinWeights=[];for(var n=0;n<e.vertices.length;n++)e.skinIndices.push(new i.Vector4(t,0,0,0)),e.skinWeights.push(new i.Vector4(1,0,0,0))}else console.error("initializeIndicesAndWeights:geometry only support Normal Geometry");else console.error("initializeIndicesAndWeights:geometry undefined or null")},t.copyIndicesAndWeights=function(e,t){if(e||console.error("copyIndicesAndWeights:fromGeo undefined or null"),t||console.error("copyIndicesAndWeights:toGeo undefined or null"),t.isGeometry||console.error("copyIndicesAndWeights:toGeo only support Normal Geometry"),t.skinIndices=[],t.skinWeights=[],e.isGeometry)for(var n=0;n<e.skinIndices.length;n++)t.skinIndices.push(e.skinIndices[a].clone()),t.skinWeights.push(e.skinWeights[a].clone());else if(e.isBufferGeometry)for(var o=e.attributes,s=o.skinIndex.array,r=o.skinWeight.array,a=0;a<s.length;a+=4)t.skinIndices.push(new i.Vector4(s[a],s[a+1],s[a+2],s[a+3])),t.skinWeights.push(new i.Vector4(r[a],r[a+1],r[a+2],r[a+3]));else console.error("copyIndicesAndWeights:toGeo is not Geometry nor BufferGeometry")},t.getBoneList=a,t.makeBoneList=function(e){var t={};return e.traverse((function(e){e.isBone&&(t[e.uuid]=e)})),Object.values(t)},t.getBoneIdOptions=function(e){var t=a(e),n={};return t.forEach((function(e){n[e.id]=e.name})),n},t.getBoneNameOptions=function(e){for(var t=a(e),n=new Map,i=0;i<t.length;i++)n[t[i].name]=String(i);return n},t.boneListToOptions=function(e,t){var n={};if(t=null!=t&&t)for(var i=0;i<e.length;i++){var o=e[i];n[String(i)]=o.name}else for(i=0;i<e.length;i++)n[(o=e[i]).name]=String(i);return n},t.makeQuaternionFromXYZDegree=function(e,t,n,o,s){return l(i.MathUtils.degToRad(e),i.MathUtils.degToRad(t),i.MathUtils.degToRad(n),o,s)},t.makeQuaternionFromXYZRadian=l;class h{constructor(e,t,n){this.translate=e,this.scale=t,this.rotation=n}}t.BoneMatrix=h;class d extends Map{print(){Object.keys(this).forEach((function(e){var t=this[e].rotation;if(null!=t){var n=i.MathUtils.radToDeg(t.x).toFixed(2),o=i.MathUtils.radToDeg(t.y).toFixed(2),s=i.MathUtils.radToDeg(t.z).toFixed(2);console.log(e,n,o,s)}}))}}function c(e,t){return e.isEuler||console.error("flipHorizontalRotation rotation must be Euler"),(t=null==t?new i.Euler:t).set(e.x,-1*e.y,-1*e.z,e.order),t}t.BoneMatrixMap=d,t.storeDefaultBoneMatrix=function(e){var t=new d;return e.forEach((function(e){var n=e.matrix,o=e.name;let s=new i.Vector3;s.setFromMatrixPosition(n);let r=new i.Vector3;r.setFromMatrixScale(n);let a=new i.Euler;a.setFromRotationMatrix(n),t[o]=new h(s,r,a)})),t},t.makeEmptyBoneMatrix=function(e){var t=new d,n=new i.Vector3,o=new i.Vector3(1,1,1),s=new i.Euler;return e.forEach((function(e){var i=e.name;t[i]=new h(n.clone(),o.clone(),s.clone())})),t},t.findBoneIndexByBoneName=function(e,t){return this.findBoneIndexByEndsName(e,t)},t.findBoneIndexByEndsName=function(e,t){for(var n=0;n<e.length;n++)if(e[n].name.toLowerCase().endsWith(t.toLowerCase()))return n;return-1},t.findBoneByBoneName=function(e,t){return this.findBoneByEndsName(e,t)},t.findBoneByEndsName=function(e,t){for(var n=0;n<e.length;n++)if(e[n].name.toLowerCase().endsWith(t.toLowerCase()))return e[n];return null},t.convertToZeroRotatedBoneMesh=function(e){e.updateMatrixWorld(!0);var t=a(e),n=[];t.forEach((function(e){var t=(new i.Vector3).setFromMatrixPosition(e.matrixWorld);n.push(t)}));for(var o=[],s=0;s<t.length;s++){var l=t[s],h=t.indexOf(l.parent),d=-1==h?new i.Vector3:n[h].clone(),c=n[s].clone().sub(d),g=new r(h,l.name);g.pos=c.toArray(),o.push(g)}var u=(new i.BufferGeometry).copy(e.geometry),m=new i.Skeleton(o),p=new i.SkinnedMesh(u);return p.add(m.bones[0]),p.bind(m),p},t.resetBone=function(e,t){var n=a(e),o=n[t];if(e.skeleton.boneInverses[t].copy(o.matrixWorld).invert(),o.parent&&o.parent instanceof i.Bone){var s=n.indexOf(o.parent),r=e.skeleton.boneInverses[s];o.matrix.copy(r),o.matrix.multiply(o.matrixWorld)}else o.matrix.copy(o.matrixWorld);o.matrix.decompose(o.position,o.quaternion,o.scale),o.updateMatrixWorld(!0)},t.getOppositeLRName=function(e){return e.endsWith("_L")?e.substring(0,e.length-2)+"_R":e.endsWith("_R")?e.substring(0,e.length-2)+"_L":null},t.flipHorizontalRotation=c,t.swapHorizontalBone=function(e,t){var n=c(e.rotation,null),i=c(t.rotation,null);e.rotation.copy(i),t.rotation.copy(n)}},1835:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HumanoidIK=void 0;const i=n(2212),o=n(5243),s=n(6745),r=n(9931),a=n(3411);var l=r.VRMSchema.HumanoidBoneName;t.HumanoidIK=class{constructor(e,t,n){this.ikController=e,this.boneAttachController=t,this.endSites=[],this.ikTargets={},this.bodyHumanBoneNames=[l.Hips,l.Spine,l.Chest,l.UpperChest,l.Neck,l.Head];var i=n.humanoid.humanBones,s=new Map;for(let e in i){let t=i[e];t[0]&&(s[e]=t[0].node.name)}function r(e){var t=[];return e.forEach((function(e){var n=i[e];if(n){var o=n[0];null!=o?t.push(o.node.name):console.log("humanBoneMap:found on map not in bonelist",e)}else console.log("humanBoneMap:not map found",e)})),t}if(this.humanBoneMap=s,this.boneIkMap=new Map,this.boneList=o.getBoneList(n.scene),this.headBoneNames=r([l.Spine,l.Chest,l.UpperChest,l.Neck,l.Head]),this.registIk(this.ikTargets,"Head",this.headBoneNames),this.leftArmBoneNames=r([l.LeftShoulder,l.LeftUpperArm,l.LeftLowerArm,l.LeftHand]),this.registIk(this.ikTargets,"LeftArm",this.leftArmBoneNames),this.rightArmBoneNames=r([l.RightShoulder,l.RightUpperArm,l.RightLowerArm,l.RightHand]),this.registIk(this.ikTargets,"RightArm",this.rightArmBoneNames),this.leftLegBoneNames=r([l.LeftUpperLeg,l.LeftLowerLeg,l.LeftFoot]),this.registIk(this.ikTargets,"LeftLeg",this.leftLegBoneNames),this.rightLegBoneNames=r([l.RightUpperLeg,l.RightLowerLeg,l.RightFoot]),this.registIk(this.ikTargets,"RightLeg",this.rightLegBoneNames),this.hipBoneNames=r([l.Hips,l.Spine]),this.hipBoneNames.length>1){this.registIk(this.ikTargets,"Hip",this.hipBoneNames);for(let e of this.hipBoneNames)this.boneAttachController.setCanTranslate(e,!0)}this.initlimitBone()}registIk(e,t,n){if(0==n.length)throw new Error("No joint names");var r=[],l=this.ikController.iks[t];l&&l.dispose(),this.ikController.iks[t]=new a.IKData(r,t);var h=this;n.forEach((function(e){var n=o.findBoneIndexByEndsName(h.boneList,e);-1==n&&console.error("registIk:bone not contain,"+e),r.push(n),h.boneIkMap[e]=t}));var d=this.boneAttachController.getContainerList(),c=new i.Mesh(new i.BoxGeometry(.02,.02,.02),new i.MeshBasicMaterial({color:34816,depthTest:!1,transparent:!0,opacity:.5}));c.renderOrder=2,d[r[r.length-1]].add(c),d[r[r.length-1]].userData.endsite=c,c.material.visible=!1,c.userData.endSiteIndex=r[r.length-1],c.userData.endSiteParentIndex=r[r.length-2];var g=s.lineTo(d[r[r.length-1]],c);const u=g.material;u.depthTest=!1,u.transparent=!0,u.opacity=.25,g.renderOrder=2,u.visible=!1,c.userData.joint=g,this.endSites.push(c);var m=new i.Mesh(new i.BoxGeometry(.05,.05,.05),new i.MeshBasicMaterial({color:8912896,depthTest:!1,transparent:!0,opacity:.5}));m.name="ik-c-"+t,m.renderOrder=1,r.length,m.userData.ikName=t,m.userData.transformSelectionType="BoneIk",this.ikController.addTarget(m),this.ikController.iks[t].target=m,this.boneAttachController.targetBones(new Set(n),!0)}limitBone(e,t,n,o,s,r,a,l){var h=this.humanBoneMap[t];if(!h)throw new Error("Not found: "+t);this.ikController.ikLimitMin[h]=new i.Vector3(n,o,s),this.ikController.ikLimitMax[h]=new i.Vector3(r,a,l)}initlimitBone(){var e=this.boneList;this.limitBone(e,l.Hips,-180,-180,-180,180,180,180),this.limitBone(e,l.Spine,-15,-30,-20,15,30,20),this.limitBone(e,l.Chest,-45,-30,-20,45,30,20),this.limitBone(e,l.UpperChest,-45,-30,-20,45,30,20),this.limitBone(e,l.Neck,-45,-45,-10,45,45,10),this.limitBone(e,l.Head,-15,-30,-20,15,30,20),this.limitBone(e,l.LeftShoulder,0,0,-45,0,15,0),this.limitBone(e,l.LeftUpperArm,-45,-75,-45,45,45,85),this.limitBone(e,l.LeftLowerArm,-0,-150,0,0,0,0),this.limitBone(e,l.LeftHand,0,0,-45,0,45,65),this.limitBone(e,l.RightShoulder,0,-15,0,0,0,45),this.limitBone(e,l.RightUpperArm,-45,-45,-85,45,75,45),this.limitBone(e,l.RightLowerArm,0,0,0,0,150,0),this.limitBone(e,l.RightHand,0,-45,-65,0,0,45),this.limitBone(e,l.LeftUpperLeg,-60,0,-75,120,0,75),this.limitBone(e,l.LeftLowerLeg,-160,0,0,0,0,0),this.limitBone(e,l.LeftFoot,-15,-5,-5,15,5,5),this.limitBone(e,l.RightUpperLeg,-60,0,-75,120,0,75),this.limitBone(e,l.RightLowerLeg,-160,0,0,0,0,0),this.limitBone(e,l.RightFoot,-15,-5,-5,15,5,5);var t=this;Object.keys(this.ikController.iks).forEach((function(e){t.ikController.ikDefaultLimitMin[e]=new i.Vector3(t.ikController.iks[e].limitMin),t.ikController.ikDefaultLimitMax[e]=new i.Vector3(t.ikController.iks[e].limitMax)}))}}},1657:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IKController=void 0;const i=n(2212),o=n(6745),s=n(5243),r=n(781);t.IKController=class{constructor(e,t){this.signals=e,this.boneAttachController=t,this.logging=!1,this.iks=new Map,this.object3d=new i.Object3D,this.ikLimitMin=new Map,this.ikLimitMax=new Map,this.ikDefaultLimitMin=new Map,this.ikDefaultLimitMax=new Map,this.ikBoneRatio={},this._ikSolved={},this.selectedIk=null,this.ikPresets=null,this.ikLockX=!1,this.ikLockY=!1,this.ikLockZ=!1,this.boneLocked={},this.ikBoneSelectedOnly=!1,this.ikLimitkRotationEnabled=!0,this.followOtherIkTargets=!0,this.maxAngle=1,this.iteration=25,this.boneSelectedIndex=0,this.debug=!1,this._initialized=!1,this._enabled=!0,this._solving=!1,this._mouseDown=!1,this.lastTargetMovedPosition=new i.Vector3,this._euler=new i.Euler,this._pos=new i.Vector3,this._cubeMatrix=new i.Matrix4,this._matrixWorldInv=new i.Matrix4,this._quaternion=new i.Quaternion}onIkSelectionChanged(e){this.logging&&console.log("onIkSelectionChanged called",e)}setVisible(e){var t=this;t.getIkTargetsValue().forEach((function(n){n.visible=e;var i=t.getIkNameFromTarget(n);t.isEnableEndSiteByName(i)&&t.setEndSiteVisible(i,e)}))}setEnabled(e){this._enabled=e,this.setVisible(e)}isEnabled(){return this._enabled}addTarget(e){this.object3d.add(e)}setBoneAttachController(e){this.boneSelectedIndex=0,this.boneAttachController=e,this.resetIkSettings(),this.resetAllIkTargets(null)}resetIkSettings(){var e=this,t=this.boneAttachController.getContainerList();this.ikSettings.endSites.forEach((function(n){var i=n.userData.endSiteIndex,o=n.userData.endSiteParentIndex;t[i].add(n),t[i].add(n.userData.joint),t[i].userData.endsite=n,e.logging&&console.log("endsite position recalucurate",i);var s=t[i].position.clone().sub(t[o].position);n.userData.length&&n.userData.length,n.position.copy(s);let r=n.userData.joint;r.geometry.attributes.position.setX(0,s.x),r.geometry.attributes.position.setY(0,s.y),r.geometry.attributes.position.setZ(0,s.z),r.geometry.attributes.position.needsUpdate=!0}))}initialize(e){this.ikSettings=e,this._onbsc=e=>this.boneSelectedIndex=e,this.signals.onBoneSelectionChanged.subscribe(this._onbsc),this._onpc=()=>this.resetAllIkTargets(),this.signals.onPoseChanged.subscribe(this._onpc),this._onsic=()=>this.solveIk(!0),this.signals.onSolveIkCalled.subscribe(this._onsic),this._onisc=e=>this.onIkSelectionChanged(e),this.signals.onIkSelectionChanged.subscribe(this._onisc),this._onbrc=e=>{var t=this.getSelectedIkName();this.resetAllIkTargets(t),0==e&&this.signals._onBoneTranslateChanged.dispatch(e)},this.signals.onBoneRotateChanged.subscribe(this._onbrc),this.setBoneAttachController(this.boneAttachController),this._initialized=!0}dispose(){this.signals.onIkSelectionChanged.unsubscribe(this._onisc),this.signals.onBoneSelectionChanged.unsubscribe(this._onbsc),this.signals.onPoseChanged.unsubscribe(this._onpc),this.signals.onSolveIkCalled.unsubscribe(this._onsic),this.signals.onBoneRotateChanged.unsubscribe(this._onbrc),Object.values(this.iks).forEach((function(e){e.dispose()})),this.iks.clear()}isInitialized(){return this._initialized}getIkNameFromTarget(e){return null==e||null==e?e:e.userData.ikName?e.userData.ikName:null}getIkTargetFromName(e){return this.iks[e].target}getIkTargetsValue(){return Object.values(this.iks).map((e=>e.target))}setPresets(e){this.ikPresets&&this.ikPresets.dispose(),this.ikPresets=e,e.ikController=this}getPresets(){return this.ikPresets}getBoneList(){return this.boneAttachController.getBoneList()}getIndices(e){return this.iks[e]}getBoneRatioAsJson(){return JSON.stringify(this.ikBoneRatio)}setBoneRatioFromJson(e){this.ikBoneRatio=e,Object.keys(e).forEach((t=>{var n=this.iks[t];n&&(n.boneRatio=e[t])}))}clearBoneRatio(){Object.values(this.iks).forEach((e=>e.boneRatio=1))}setBoneRatio(e,t){this.ikBoneRatio[e]=t}getBoneRatio(e){return null==this.ikBoneRatio[e]?1:this.ikBoneRatio[e]}getSelectedIkName(){return null!=this.selectedIk?this.selectedIk.name:null}getIkNames(){return Object.keys(this.iks)}isEnableEndSiteByName(e){this.iks[e].target;var t=this.iks[e],n=t.indices[t.indices.length-1],i=this.boneAttachController.getContainerList()[n];return this.enableEndSite(i)}enableEndSite(e){return e.userData.endsite&&1==e.userData.endsite.userData.enabled}updateIkTargets(){this._matrixWorldInv.copy(this.object3d.matrixWorld).invert(),this.object3d.getWorldQuaternion(this._quaternion),this.boneAttachController.updateMatrix();for(let o in this.iks){var e=this.iks[o],t=e.indices[e.indices.length-1],n=this.boneAttachController.getContainerList()[t];let s=e.target;var i=n.userData.ikPosition;s.position.copy(i),this.boneAttachController.updateOne(t)}}resetAllIkTargets(e=null){var t=this;this.boneAttachController.update(),Object.keys(this.iks).forEach((function(n){n!=e&&t.resetIkTargetPosition(n)}))}resetIkTargetPosition(e){var t=this.iks[e].target,n=this.getLastPosition(e);t.position.copy(n)}getLastPosition(e){this.iks[e].target;var t=this.iks[e],n=t.indices[t.indices.length-1],i=this.boneAttachController.getContainerList()[n],o=i.userData.ikPosition;return this.enableEndSite(i)&&(o=i.userData.endsite.getWorldPosition(this._pos)),o}setEndSiteEnabled(e,t){null==this.iks[e].target&&console.error("setEndSiteEnabled:No target found ",e);var n=this.iks[e],i=n.indices[n.indices.length-1],o=this.boneAttachController.getContainerList()[i];o.userData.endsite.userData.enabled=t,o.userData.endsite.material.visible=t,o.userData.endsite.userData.joint.material.visible=t,this.resetIkTargetPosition(e)}setEndSiteVisible(e,t){this.iks[e].target||console.error("setEndSiteEnabled:No target found ",e);var n=this.iks[e],i=n.indices[n.indices.length-1],o=this.boneAttachController.getContainerList()[i];o.userData.endsite.material.visible=t,o.userData.endsite.userData.joint.material.visible=t}setIkTarget(e){null==e?(this.selectedIk=null,this.signals._onIkSelectionChanged.dispatch(null),this.resetAllIkTargets(null)):(this.selectedIk=this.iks[e.userData.ikName],this.signals._onIkSelectionChanged.dispatch([e,this.getIkNameFromTarget(e)]))}clearIkTarget(){this.setIkTarget(null)}solveOtherIkTargets(){var e=this.selectedIk,t=this;Object.values(this.iks).forEach((function(n){t.setIkTarget(n.target),e!=n.target&&t.solveIk(!1)&&(t._ikSolved[n.name]=!0,t.logging&&console.log("ik solved",n.name))})),this.setIkTarget(e.target)}onTransformSelectionChanged(e){var t=this;if(null==e)this.clearIkTarget();else if(e[1]&&"BoneIk"==e[1].userData.transformSelectionType&&this._enabled){t.logging&&console.log("IkController onTransformSelectionChanged");let n=e[0],i=e[1];t.setIkTarget(i),n.setMode("translate"),n.showX=!0,n.showY=!0,n.showZ=!0,t.logging&&console.log("IkController dispatch ikSelectionChanged",t.getIkNameFromTarget(i))}else this.clearIkTarget()}onTransformChanged(e){if(null!=e){let n=e[1];if("BoneIk"==n.userData.transformSelectionType){if(this.logging&&console.log("IkController onTransformChanged"),0==this._mouseDown)return void(this.logging&&console.log("IkController not mouse down"));if(this._solving)return void(this.logging&&console.log("IkController still solving ignored"));this._solving=!0;var t=this.solveIk(!1);this._solving=!1,t&&(this._ikSolved[this.getIkNameFromTarget(n)]=!0,this.logging&&console.log("ik solved",this.getIkNameFromTarget(n)),this.followOtherIkTargets||this.solveOtherIkTargets()),this.boneAttachController.update()}else this.resetAllIkTargets()}}onTransformRotateChanged(e){null!=e&&this.resetAllIkTargets()}onTransformStarted(e){null!=e&&"BoneIk"==e.userData.transformSelectionType&&(this.logging&&console.log("IkController onTransformStarted"),this._mouseDown=!0,this._ikSolved={},this.resetAllIkTargets(this.getIkNameFromTarget(e)))}onTransformFinished(e){var t=this;null!=e&&"BoneIk"==e.userData.transformSelectionType&&(this.logging&&console.log("IkController onTransformFinished"),this._mouseDown=!1,Object.keys(this._ikSolved).forEach((function(e){1==t._ikSolved[e]&&t.getEffectedBoneIndices(e).forEach((function(e){t.signals._onBoneRotateChanged.dispatch(e),t.logging&&console.log("IkController dispatch boneRotationChanged",e),t.signals._onBoneRotateFinished.dispatch(e),t.logging&&console.log("IkController dispatch boneRotationFinished",e)}))})),this.resetAllIkTargets())}getEffectedBoneIndices(e){for(var t=this.iks[e].indices,n=[],i=this.isEnableEndSiteByName(e)?t.length:t.length-1,o=0;o<i;o++){var s=t[o];n.push(s)}return n}solveIk(e=!1){this.logging&&console.log("call solveIk ",this.selectedIk),e=null!=e&&e;var t=this;function n(e){var n=e.userData.ikPosition;return t.enableEndSite(e)&&(n=e.userData.endsite.getWorldPosition(t._pos)),n}if(null==this.selectedIk)return this.debug&&console.log("ikTarget is null"),!1;var a=this.selectedIk.name,l=this.selectedIk.indices,h=this.boneAttachController.getContainerList()[l[l.length-1]],d=this.selectedIk.target,c=d.position;if(this.lastTargetMovedPosition.equals(c)&&0==e)return this.debug&&console.log(a,"lastTargetMovedPosition same as targetPos forceUpdate=",e),!1;if(this.lastTargetMovedPosition.copy(c),d.position.equals(n(h)))return this.debug&&console.log(a,"ik target pos == endsitepos"),!1;for(var g=0;g<this.iteration;g++){for(var u=t.enableEndSite(h)?l.length:l.length-1,m=0;m<u;m++){var p=l[m];if(this.ikBoneSelectedOnly&&p!=this.boneSelectedIndex)this.logging&&console.log("ik ikBoneSelectedOnly & skipped",p);else{var f=n(h),k=this.boneAttachController.getBoneList()[p],v=k.name,b=this.boneAttachController.getContainerList()[l[m]].userData.ikPosition;if(this.boneLocked[v])this.logging&&console.log("ik bonelocked & skipped",v);else{if(c.equals(f))return this.logging&&console.log(a,"no need ik, skipped"),!1;var C=k.parent.getWorldQuaternion(new i.Quaternion).invert();k.parent,i.Bone;var T=this.maxAngle*this.getBoneRatio(k.name);this.logging&&console.log("ik maxAngle",v,T);var w=r.stepCalculate2(C,f,b,c,T);if(null!=w){var B=k.rotation.order,I=this._euler.setFromQuaternion(w,B),M=k.rotation;s.convertToIkSafeRoatation(M);var y=M.x,S=M.y,x=M.z;if(s.isD180(y)||s.isD180(S)||s.isD180(x))o.printDeg(M,"not safe ik angles");else{if(this.ikLimitkRotationEnabled){function _(e,t){var n=i.MathUtils.radToDeg(e+t);return n>180&&(n-=360),n<-180&&(n+=180),n}const e=this.ikLimitMin[k.name],t=this.ikLimitMax[k.name];if(e){var L=_(y,I.x);!this.ikLockX&&L>=e.x&&L<=t.x?y+=I.x:this.debug&&console.log(k.name,"limit-x",e.x,t.x,L);var D=_(S,I.y);!this.ikLockY&&D>=e.y&&D<=t.y?S+=I.y:this.debug&&console.log(k.name,"limit-y",e.y,t.y,D);var E=_(x,I.z);!this.ikLockZ&&E>=e.z&&E<=t.z?x+=I.z:this.debug&&console.log(k.name,"limit-z",e.z,t.z,E),y>Math.PI&&(y-=2*Math.PI),S>Math.PI&&(S-=2*Math.PI),x>Math.PI&&(x-=2*Math.PI),y<-Math.PI&&(y+=2*Math.PI),S<-Math.PI&&(S+=2*Math.PI),x<-Math.PI&&(x+=2*Math.PI)}else this.logging&&console.log("no ikLimitMin",k.name)}else this.logging&&console.log("ik not limited",v,I.x.toFixed(2),I.y.toFixed(2),I.z.toFixed(2)),y+=I.x,S+=I.y,x+=I.z;k.rotation.set(y,S,x)}}else this.logging&&console.log("null quaternion")}}}for(this.boneAttachController.updateMatrix(),m=u;m>=0;m--)this.boneAttachController.updateOne(l[m])}return this.followOtherIkTargets&&this.resetAllIkTargets(a),!0}}},3411:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IKData=void 0,t.IKData=class{constructor(e,t){this.indices=e,this.name=t,this.boneRatio=1}addToScene(e){if(!this.target)throw new Error("Target not ready!");e.add(this.target)}dispose(){this.target&&this.target.parent.remove(this.target)}}},4405:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IKModel=void 0;const i=n(7270),o=n(1657),s=n(1835),r=n(64);t.IKModel=class{constructor(e,t){this.signals=e,this.vrm=t,this.boneAttachController=new i.BoneAttachController(this.vrm.scene),this.ikController=new o.IKController(this.signals,this.boneAttachController),this.jointController=new r.JointController(this.signals,this.boneAttachController,this.ikController),this._onpc=()=>this.boneAttachController.update(!0),this.signals.onPoseChanged.subscribe(this._onpc),this.settings=new s.HumanoidIK(this.ikController,this.boneAttachController,this.vrm),this.ikController.initialize(this.settings),this.signals._onIkSettingChanged.dispatch(),this._ontsc=e=>this.onTransformSelectionChanged(e),this._onts=e=>this.onTransformStarted(e),this._ontf=e=>this.onTransformFinished(e),this._ontc=e=>this.onTransformChanged(e),this._ontrc=e=>this.onTransformRotateChanged(e),this.signals.onTransformSelectionChanged.subscribe(this._ontsc),this.signals.onTransformStarted.subscribe(this._onts),this.signals.onTransformFinished.subscribe(this._ontf),this.signals.onTransformChanged.subscribe(this._ontc),this.signals.onTransformRotateChanged.subscribe(this._ontrc),this._onbtc=()=>this.ikController.resetAllIkTargets(),this.signals.onBoneTranslateChanged.subscribe(this._onbtc),this.signals._onLoadingModelFinished.dispatch(this)}addToScene(e){e.add(this.ikController.object3d),e.add(this.vrm.scene),this.ikController.object3d.updateWorldMatrix(!0,!0)}update(e){this.vrm.update(e)}onTransformSelectionChanged(e){this.jointController.onTransformSelectionChanged(e),this.ikController.onTransformSelectionChanged(e)}onTransformStarted(e){this.jointController.onTransformStarted(e),this.ikController.onTransformStarted(e)}onTransformFinished(e){this.jointController.onTransformFinished(e),this.ikController.onTransformFinished(e)}onTransformChanged(e){this.jointController.onTransformChanged(e),this.ikController.onTransformChanged(e)}onTransformRotateChanged(e){this.jointController.onTransformRotateChanged(e),this.ikController.onTransformRotateChanged(e)}dispose(){this.signals.onPoseChanged.unsubscribe(this._onpc),this.signals.onTransformSelectionChanged.unsubscribe(this._ontsc),this.signals.onTransformStarted.unsubscribe(this._onts),this.signals.onTransformFinished.unsubscribe(this._ontf),this.signals.onTransformChanged.unsubscribe(this._ontc),this.signals.onTransformRotateChanged.unsubscribe(this._ontrc),this.signals.onBoneTranslateChanged.unsubscribe(this._onbtc),this.boneAttachController.dispose(),this.ikController.dispose()}}},3979:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IKPose=void 0;const i=n(2212),o=n(4376),s=n(2886),r=n(7047),a=n(9931),l=n(4315),h=n(4405),d=n(2281);t.IKPose=class{constructor(){this.ikModels=[],this.params={showIk:!0},this.renderer=new i.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(this.renderer.domElement),this.scene=new i.Scene,this.scene.background=new i.Color(15790320),this.camera=new i.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e4),this.camera.position.set(0,2.5,1.5),this.scene.add(this.camera),this.signals=new l.Signals,this.addLight(),this.addPlane(),this.addGrid(),this.bindControls(),this.openGUI();let e=this;window.addEventListener("resize",(function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight),e.render()}),!1),this.render()}addLight(){this.scene.add(new i.AmbientLight(15790320));const e=new i.SpotLight(16777215,1.5);e.position.set(0,1500,200),e.angle=.2*Math.PI,e.castShadow=!0,e.shadow.camera.near=200,e.shadow.camera.far=2e3,e.shadow.bias=-222e-6,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,this.scene.add(e)}addPlane(){const e=new i.PlaneGeometry(2e3,2e3);e.rotateX(-Math.PI/2);const t=new i.ShadowMaterial({opacity:.2}),n=new i.Mesh(e,t);n.position.y=-1,n.receiveShadow=!0,this.scene.add(n)}addGrid(){const e=new i.GridHelper(50,100);e.position.y=0;const t=e.material;t.opacity=.25,t.transparent=!0,this.scene.add(e)}bindControls(){var e=this;this.controls=new s.OrbitControls(this.camera,this.renderer.domElement),this.controls.addEventListener("change",(()=>e.render())),this.transformHandler=new d.TransformHandler(this.signals,this),this.signals.onJointSelectionChanged.subscribe((t=>{t&&e.transformHandler.setTarget(t),e.render()})),this.signals.onIkSelectionChanged.subscribe((t=>{t&&e.transformHandler.setTarget(t[0]),e.render()}))}openGUI(){let e=this;const t=new o.GUI;t.add(this.params,"showIk").onChange((t=>e.setShowIk(t))),t.open()}setShowIk(e){for(let t of this.ikModels)t.ikController.setVisible(e);this.transformHandler.selectTarget(null),this.render()}render(){this.update(0),this.renderer.render(this.scene,this.camera)}update(e){}loadModel(e,t){(new r.GLTFLoader).load(e,(e=>a.VRM.from(e).then((e=>this.onModelLoadSuccess(e,t)))),(e=>this.onModelLoadProgress(e)),(e=>this.onModelLoadError(e)))}onModelLoadSuccess(e,t){const n=new h.IKModel(this.signals,e);this.ikModels.push(n),n.vrm.scene.position.copy(t),n.vrm.humanoid.getBoneNode(a.VRMSchema.HumanoidBoneName.Hips).rotation.y=Math.PI,n.ikController.setVisible(this.params.showIk),n.addToScene(this.scene),console.log(e),this.render()}onModelLoadProgress(e){console.log("Loading model...",e.loaded/e.total*100,"%")}onModelLoadError(e){console.error(e)}getIkTargets(){const e=this.ikModels.map((e=>e.ikController.getIkTargetsValue()));return[].concat.apply([],e)}getJointTargets(){const e=this.ikModels.map((e=>e.boneAttachController.getContainerList()));return[].concat.apply([],e)}}},781:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.stepCalculate2=t.poseAngles=t.stepCalculate=t.calculateAngles=void 0;const i=n(2212);let o=new i.Quaternion,s=new i.Vector3,r=new i.Vector3,a=new i.Vector3,l=new i.Euler,h=i.MathUtils.degToRad(.001);function d(e,t,n){s.copy(e);var i=s.sub(t).normalize();r.copy(n);var l=r.sub(t).normalize(),d=i.dot(l),c=Math.acos(d);if(c<=h)return null;var g=a.crossVectors(i,l);return g.normalize(),o.setFromAxisAngle(g,c)}function c(e,t,n,i){var l=s.copy(t).sub(n);l.applyQuaternion(e),l.normalize();var d=r.copy(i).sub(n);d.applyQuaternion(e),d.normalize();var c=l.dot(d),g=Math.acos(c);if(g<=h)return null;var u=a.crossVectors(l,d);return u.normalize(),o.setFromAxisAngle(u,g)}t.calculateAngles=d,t.stepCalculate=function(e,t,n,s,r,a){var h=d(e,t,s);if(null==h)return h=o.set(0,0,0,1),a?h.multiply(n):h;if(void 0!==r&&r>0){var c=i.MathUtils.degToRad(r),g=l.setFromQuaternion(h),u=Math.abs(g.x);if(Math.abs(g.y)>u&&(u=Math.abs(g.y)),Math.abs(g.z)>u&&(u=Math.abs(g.z)),u>c){var m=u/c;g.x=g.x/m,g.y=g.y/m,g.z=g.z/m}g.x>c+1e-7||g.y>c+1e-7||g.z>c+1e-7?h.set(0,0,0,1):h.setFromEuler(g)}return a?h.multiply(n):h},t.poseAngles=c,t.stepCalculate2=function(e,t,n,o,s){var r=c(e,t,n,o);if(null==r||isNaN(r.x))return null;if(void 0!==s&&s>0){var a=i.MathUtils.degToRad(s),h=l.setFromQuaternion(r),d=Math.abs(h.x);if(Math.abs(h.y)>d&&(d=Math.abs(h.y)),Math.abs(h.z)>d&&(d=Math.abs(h.z)),d>a){var g=d/a;h.x=h.x/g,h.y=h.y/g,h.z=h.z/g}return h.x>a+1e-7||h.y>a+1e-7||h.z>a+1e-7?null:(r.setFromEuler(h),r)}return r}},64:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.JointController=void 0;const i=n(2212);t.JointController=class{constructor(e,t,n){this.signals=e,this.boneAttachController=t,this.ikController=n,this.logging=!1,this._mouseDown=!1,this._enabled=!0}setJointTarget(e){null==e?(this.selectedJoint=null,this.signals._onJointSelectionChanged.dispatch(null)):(this.selectedJoint=e,this.signals._onJointSelectionChanged.dispatch(e))}clearJointTarget(){this.setJointTarget(null)}onTransformSelectionChanged(e){if(null==e)this.clearJointTarget();else if(e[1]&&"Joint"==e[1].userData.transformSelectionType&&e[1].userData.isTargetable&&this._enabled){this.logging&&console.log("JointController onTransformSelectionChanged");let t=e[0],n=e[1];this.setJointTarget(n);let i=n.userData.bone;const o=this.ikController.ikLimitMin[i.name],s=this.ikController.ikLimitMax[i.name];n.userData.isSelected&&"rotate"==t.getMode()&&n.userData.canTranslate?(t.setMode("translate"),t.showX=!0,t.showY=!0,t.showZ=!0):(t.setMode("rotate"),o?(t.showX=o.x<s.x,t.showY=o.y<s.y,t.showZ=o.z<s.z):(t.showX=!0,t.showY=!0,t.showZ=!0))}else this.clearJointTarget()}onTransformChanged(e){if(null!=e&&"Joint"==e[1].userData.transformSelectionType&&e[1].userData.isTargetable){let h=e[1].userData.bone;const d=this.ikController.ikLimitMin[h.name],c=this.ikController.ikLimitMax[h.name];var t=h.rotation;let g=t.x,u=t.y,m=t.z;if(d){var n=i.MathUtils.degToRad(d.x),o=i.MathUtils.degToRad(c.x),s=i.MathUtils.degToRad(d.y),r=i.MathUtils.degToRad(c.y),a=i.MathUtils.degToRad(d.z),l=i.MathUtils.degToRad(c.z);g=Math.min(Math.max(g,n),o),u=Math.min(Math.max(u,s),r),m=Math.min(Math.max(m,a),l)}h.rotation.set(g,u,m)}}onTransformRotateChanged(e){null!=e&&"Joint"==e[1].userData.transformSelectionType&&e[1].userData.isTargetable&&(e[1],this.logging&&console.log("JointController onTransformChanged"),0==this._mouseDown)&&this.logging&&console.log("JointController not mouse down")}onTransformStarted(e){null!=e&&"Joint"==e.userData.transformSelectionType&&e.userData.isTargetable&&(this.logging&&console.log("JointController onTransformStarted"),this._mouseDown=!0)}onTransformFinished(e){null!=e&&"Joint"==e.userData.transformSelectionType&&e.userData.isTargetable&&(this.logging&&console.log("JointController onTransformFinished"),this._mouseDown=!1)}}},4315:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Signals=void 0;const i=n(8993);t.Signals=class{constructor(){this._onBoneSelectionChanged=new i.SimpleEventDispatcher,this._onBoneTranslateChanged=new i.SimpleEventDispatcher,this._onBoneRotateChanged=new i.SimpleEventDispatcher,this._onBoneRotateFinished=new i.SimpleEventDispatcher,this._onTransformSelectionChanged=new i.SimpleEventDispatcher,this._onTransformStarted=new i.SimpleEventDispatcher,this._onTransformFinished=new i.SimpleEventDispatcher,this._onTransformChanged=new i.SimpleEventDispatcher,this._onTransformRotateChanged=new i.SimpleEventDispatcher,this._onPoseChanged=new i.SignalDispatcher,this._onSolveIkCalled=new i.SignalDispatcher,this._onIkSettingChanged=new i.SignalDispatcher,this._onIkSelectionChanged=new i.SimpleEventDispatcher,this._onJointSelectionChanged=new i.SimpleEventDispatcher,this._onLoadingModelFinished=new i.SimpleEventDispatcher}get onBoneSelectionChanged(){return this._onBoneSelectionChanged.asEvent()}get onBoneTranslateChanged(){return this._onBoneTranslateChanged.asEvent()}get onBoneRotateChanged(){return this._onBoneRotateChanged.asEvent()}get onBoneRotateFinished(){return this._onBoneRotateFinished.asEvent()}get onTransformSelectionChanged(){return this._onTransformSelectionChanged.asEvent()}get onTransformStarted(){return this._onTransformStarted.asEvent()}get onTransformFinished(){return this._onTransformFinished.asEvent()}get onTransformChanged(){return this._onTransformChanged.asEvent()}get onTransformRotateChanged(){return this._onTransformRotateChanged.asEvent()}get onPoseChanged(){return this._onPoseChanged.asEvent()}get onSolveIkCalled(){return this._onSolveIkCalled.asEvent()}get onIkSettingChanged(){return this._onIkSettingChanged.asEvent()}get onIkSelectionChanged(){return this._onIkSelectionChanged.asEvent()}get onJointSelectionChanged(){return this._onJointSelectionChanged.asEvent()}get onLoadingModelFinished(){return this._onLoadingModelFinished.asEvent()}}},2281:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TransformHandler=void 0;const i=n(2212),o=n(3633);t.TransformHandler=class{constructor(e,t){this.signals=e,this.ikpose=t,this.lastSelection=null,this.visibleJoint=null,this.onDownPosition=new i.Vector2,this.onUpPosition=new i.Vector2,this.onMovePosition=new i.Vector2,this.onDoubleClickPosition=new i.Vector2,this.dragging=!1,this._onpu=null;var n=this;this.control=new o.TransformControls(t.camera,t.renderer.domElement),this.control.setSpace("local"),this.control.addEventListener("dragging-changed",(function(e){n.ikpose.controls.enabled=!e.value,n.dragging=e.value})),this.control.addEventListener("change",(function(e){n.dragging&&n.signals._onTransformChanged.dispatch([n.control,n.target]),n.ikpose.render()})),this.control.addEventListener("rotationAngle-changed",(function(e){n.signals._onTransformRotateChanged.dispatch([n.control,n.target]),n.ikpose.render()})),this.control.detach(),t.scene.add(this.control),this.signals.onTransformSelectionChanged.subscribe((function(e){let t=e[1];n.target&&"Joint"==n.target.userData.transformSelectionType&&(n.target.visible=!1,n.target.userData.isSelected=!1),n.target=t,null==t?n.control.detach():n.target.userData.isSelected=!0})),this._onpu=e=>this.onPointerUp(e),window.addEventListener("pointerdown",(e=>this.onPointerDown(e)),!1),window.addEventListener("pointerup",this._onpu,!1),window.addEventListener("pointermove",(e=>this.onPointerMove(e)),!1)}selectTarget(e){this.signals._onTransformSelectionChanged.dispatch([this.control,e])}setTarget(e){let t=e;e&&"Joint"==e.userData.transformSelectionType&&(t=e.parent),this.control.attach(t)}getIntersects(e,t){var n=new i.Raycaster,o=new i.Vector2;return o.set(2*e.x-1,-2*e.y+1),n.setFromCamera(o,this.ikpose.camera),n.intersectObjects(t)}getMousePosition(e,t,n){var i=e.getBoundingClientRect();return[(t-i.left)/i.width,(n-i.top)/i.height]}onPointerUp(e){var t=this.getMousePosition(this.ikpose.renderer.domElement,e.clientX,e.clientY);this.onUpPosition.fromArray(t),this.handleClick(),this.signals._onTransformFinished.dispatch(this.target),this.ikpose.render()}onPointerDown(e){var t=this.getMousePosition(this.ikpose.renderer.domElement,e.clientX,e.clientY);this.onDownPosition.fromArray(t),this.signals._onTransformStarted.dispatch(this.target),this.ikpose.render()}onPointerMove(e){var t=this.getMousePosition(this.ikpose.renderer.domElement,e.clientX,e.clientY);this.onMovePosition.fromArray(t);var n=this.getIntersects(this.onMovePosition,this.ikpose.getJointTargets());let i=null;if(n.length>0)for(var o=0;o<n.length;o++){let e=n[o].object;if("Joint"==e.userData.transformSelectionType&&e.userData.isTargetable){i=e;break}}let s=!1;i&&i!=this.visibleJoint?(this.visibleJoint&&(this.visibleJoint.visible=!1,this.visibleJoint=null),this.visibleJoint=i,this.visibleJoint.visible=!0,s=!0):!i&&this.visibleJoint&&(this.visibleJoint.visible=!1,this.visibleJoint=null,s=!0),this.target&&(this.target.visible=!0),s&&this.ikpose.render()}handleClick(){if(0===this.onDownPosition.distanceTo(this.onUpPosition)){var e=this.ikpose.getIkTargets();this.visibleJoint&&e.push(this.visibleJoint);var t=this.getIntersects(this.onUpPosition,e);if(t.length>0){for(var n=-1,i=[],o=0;o<t.length;o++)t[o].object.visible&&i.push(t[o]);if(0==i.length)return void this.selectTarget(null);n=0,0==i.length?this.lastSelection=null:i[0].object==this.lastSelection&&i.length>1?(n=1,this.lastSelection=i[1].object):this.lastSelection=i[0].object;var s=i[n].object;this.selectTarget(s)}else this.selectTarget(null)}}}},3607:(e,t,n)=>{const i=n(3979),o=n(2212),s=new i.IKPose;s.loadModel("assets/models/three-vrm-girl.vrm",new o.Vector3(-.5,0,0)),s.loadModel("assets/models/AliciaSolid.vrm",new o.Vector3(.5,0,0))}},n={};function i(e){var o=n[e];if(void 0!==o)return o.exports;var s=n[e]={exports:{}};return t[e](s,s.exports,i),s.exports}i.m=t,e=[],i.O=(t,n,o,s)=>{if(!n){var r=1/0;for(h=0;h<e.length;h++){for(var[n,o,s]=e[h],a=!0,l=0;l<n.length;l++)(!1&s||r>=s)&&Object.keys(i.O).every((e=>i.O[e](n[l])))?n.splice(l--,1):(a=!1,s<r&&(r=s));a&&(e.splice(h--,1),t=o())}return t}s=s||0;for(var h=e.length;h>0&&e[h-1][2]>s;h--)e[h]=e[h-1];e[h]=[n,o,s]},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={179:0};i.O.j=t=>0===e[t];var t=(t,n)=>{var o,s,[r,a,l]=n,h=0;for(o in a)i.o(a,o)&&(i.m[o]=a[o]);for(l&&l(i),t&&t(n);h<r.length;h++)s=r[h],i.o(e,s)&&e[s]&&e[s][0](),e[r[h]]=0;i.O()},n=self.webpackChunkikpose=self.webpackChunkikpose||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=i.O(void 0,[327],(()=>i(3607)));o=i.O(o)})();